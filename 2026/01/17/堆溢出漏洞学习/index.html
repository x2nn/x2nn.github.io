<!DOCTYPE html>
<html lang="en" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="Keep your passion for what you love !" />
  <!-- Open Graph Description ç®€çŸ­æ‘˜è¦-->
  
  <!-- ç”¨äºæœç´¢å¼•æ“çš„æ–‡ç« æ‘˜è¦ -->
  
  
  
  <title>
    
      å †æº¢å‡ºæ¼æ´å­¦ä¹  
      
      
      |
    
     Keep your passion for what you love !
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- ä»£ç å—é£æ ¼ -->
  
    
<link rel="stylesheet" href="/css/figcaption/mac-block.css">

  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 8.1.1"><link rel="alternate" href="/atom.xml" title="Keep your passion for what you love !" type="application/atom+xml">
</head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- å¤´åƒå–æ¶ˆæ‡’åŠ è½½ï¼Œæ·»åŠ no-lazy -->
      
        <img src="/images/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a href="/"></a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/categories/">
          <a href="/categories/">Category</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
        <li class="nav-item" data-path="/collections/">
          <a href="/collections/">Collections</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- æ–‡ç« è¯¦æƒ…é¡µï¼Œå±•ç¤ºæ–‡ç« å…·ä½“å†…å®¹ï¼Œurlå½¢å¼ï¼šhttps://yoursite/æ–‡ç« æ ‡é¢˜/ -->
<!-- åŒæ—¶ä¸ºã€Œæ ‡ç­¾tagã€ï¼Œã€Œæœ‹å‹friendã€ï¼Œã€Œåˆ†ç±»categoriesã€ï¼Œã€Œå…³äºaboutã€é¡µé¢çš„æ‰¿è½½é¡µé¢ï¼Œå…·ä½“å±•ç¤ºå–å†³äºpage.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.10/dist/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  


  
  <!-- æ–‡ç« å†…å®¹é¡µ urlå½¢å¼ï¼šhttps://yoursite/æ–‡ç« æ ‡é¢˜/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">å †æº¢å‡ºæ¼æ´å­¦ä¹ </div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
          2026-01-21 11:14:09
        </span>
        
              <span class="post-tags">
                <i class="iconfont icon-tags mr-10" title="Tags"></i>
                
                <span class="span--tag mr-8">
                  <a href="/tags/Heap-Overflow/" title="Heap Overflow">
                    #Heap Overflow
                  </a>
                </span>
                
                <span class="span--tag mr-8">
                  <a href="/tags/Glibc/" title="Glibc">
                    #Glibc
                  </a>
                </span>
                
              </span>
          
              <span class="post-categories">
                <i class="iconfont icon-bookmark" title="Categories"></i>
                
                <span class="span--category">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/" title="äºŒè¿›åˆ¶å®‰å…¨">
                    <b>#</b> äºŒè¿›åˆ¶å®‰å…¨
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <h2 id="ä»€ä¹ˆæ˜¯å †ï¼ˆheapï¼‰ï¼Ÿ">ä»€ä¹ˆæ˜¯å †ï¼ˆheapï¼‰ï¼Ÿ</h2>
<p>ä»æ“ä½œç³»ç»Ÿå’Œè™šæ‹Ÿå†…å­˜ç®¡ç†çš„è§†è§’æ¥çœ‹ï¼Œå †æ˜¯ä¸€ä¸ª<strong>è¢«åŠ¨çš„å†…å­˜èµ„æº</strong>ã€‚</p>
<h3 id="å®šä¹‰ä¸ä½ç½®">å®šä¹‰ä¸ä½ç½®</h3>
<ul>
<li><strong>ç‰©ç†å½¢æ€ï¼š<strong>è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ (Virtual Address Space) ä¸­çš„ä¸€ä¸ªç‰¹å®š</strong>æ®µ (Segment)</strong>ã€‚</li>
<li><strong>å†…å­˜å¸ƒå±€ï¼š</strong> é€šå¸¸ä½äº <strong>Data Segment (.bss)</strong> çš„æœ«ç«¯ä¹‹åï¼Œ<strong>Stack Segment</strong> ä¹‹å‰ï¼ˆä½åœ°å€åœ¨å‰ï¼Œé«˜åœ°å€åœ¨åï¼‰ã€‚</li>
<li><strong>ç”Ÿé•¿æ–¹å‘ï¼š</strong> <strong>å‘ä¸Šç”Ÿé•¿ (Upward Growth)</strong>ï¼Œå³ä»ä½åœ°å€å‘é«˜åœ°å€æ‰©å±•ã€‚</li>
</ul>
<p><img src="/2026/01/17/%E5%A0%86%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/image-20260120211128506.png" alt="image-20260120211128506"></p>
<h3 id="è¾¹ç•Œæ§åˆ¶">è¾¹ç•Œæ§åˆ¶</h3>
<p>å †çš„å¤§å°å¹¶éå›ºå®šï¼Œè€Œæ˜¯ç”±å†…æ ¸ç»´æŠ¤çš„è¾¹ç•ŒæŒ‡é’ˆæ§åˆ¶ï¼š</p>
<ul>
<li><strong>Program Break (<code>brk</code>):</strong> å®šä¹‰äº†å †æ®µçš„å½“å‰é¡¶éƒ¨ï¼ˆEnd of Heapï¼‰ã€‚</li>
<li><strong>æ‰©å±•æœºåˆ¶ï¼š</strong> è¿›ç¨‹é€šè¿‡ <code>brk()</code> æˆ– <code>sbrk()</code> ç³»ç»Ÿè°ƒç”¨æå‡ Program Break çš„ä½ç½®ï¼Œä»è€Œå‘å†…æ ¸ç”³è¯·æ›´å¤šçš„ç‰©ç†é¡µæ˜ å°„åˆ°è¯¥è™šæ‹Ÿåœ°å€èŒƒå›´ã€‚</li>
<li><strong>Mmap åŒºåŸŸï¼š</strong> å¯¹äºè¶…å¤§å—å†…å­˜ï¼ˆå¤§äºé˜ˆå€¼ <code>M_MMAP_THRESHOLD</code>ï¼‰ï¼Œé€šå¸¸ä¸ä½¿ç”¨ <code>brk</code> æ‰©å±•çš„ä¸»å †ï¼Œè€Œæ˜¯ä½¿ç”¨ <code>mmap()</code> åœ¨å †æ ˆä¸­é—´çš„æ–‡ä»¶æ˜ å°„åŒºåˆ†é…ç‹¬ç«‹æ®µã€‚</li>
</ul>
<h2 id="ä»€ä¹ˆæ˜¯å †ç®¡ç†å™¨ï¼ˆThe-Heap-Managerï¼‰">ä»€ä¹ˆæ˜¯å †ç®¡ç†å™¨ï¼ˆThe Heap Managerï¼‰?</h2>
<p>å †ç®¡ç†å™¨æ˜¯ä¸€ä¸ª<strong>ä¸»åŠ¨çš„è½¯ä»¶ç®—æ³•</strong>ï¼Œå±äºç”¨æˆ·æ€è¿è¡Œæ—¶åº“ï¼ˆUser-space Runtime Libraryï¼Œå¦‚ Linux ä¸‹çš„ <strong>glibc ptmalloc</strong>ï¼‰çš„ä¸€éƒ¨åˆ†ã€‚</p>
<p>å„ç§å †ç®¡ç†å™¨ï¼š</p>
<ul>
<li>
<p>dlmallocï¼šGeneral purpose allocator</p>
</li>
<li>
<p>ptmalloc2ï¼šglibc</p>
</li>
<li>
<p>jemallocï¼šfree BSD and Firefox</p>
</li>
<li>
<p>tcmallocï¼šGoogle</p>
</li>
<li>
<p>libumemï¼šSolaris</p>
</li>
</ul>
<h3 id="æ ¸å¿ƒèŒè´£">æ ¸å¿ƒèŒè´£</h3>
<p>å®ƒæ˜¯åº”ç”¨ç¨‹åºä¸æ“ä½œç³»ç»Ÿå†…æ ¸ä¹‹é—´çš„<strong>ä¸­é—´å±‚ (Abstraction Layer)</strong>ã€‚</p>
<ul>
<li><strong>å¯¹ä¸‹ (Kernel):</strong> é€šè¿‡ <code>brk/mmap</code> ç³»ç»Ÿè°ƒç”¨ï¼Œä»¥â€œé¡µ (Page, 4KB)â€ä¸ºå•ä½å‘å†…æ ¸æ‰¹å‘å¤§å—å†…å­˜ã€‚</li>
<li><strong>å¯¹ä¸Š (Application):</strong> æä¾› <code>malloc/free</code> æ ‡å‡†æ¥å£ï¼Œå®ç°â€œä»»æ„å­—èŠ‚å¤§å°â€çš„ç²¾ç»†åŒ–åˆ†é…ä¸å›æ”¶ã€‚</li>
</ul>
<h3 id="å†…éƒ¨æ•°æ®ç»“æ„-ä»¥-glibc-ä¸ºä¾‹">å†…éƒ¨æ•°æ®ç»“æ„ (ä»¥ glibc ä¸ºä¾‹)</h3>
<p>å †ç®¡ç†å™¨ä¸è§†å†…å­˜ä¸ºè¿ç»­çš„å­—èŠ‚æµï¼Œè€Œæ˜¯å°†å…¶æ ¼å¼åŒ–ä¸ºç‰¹å®šçš„æ•°æ®ç»“æ„ï¼š</p>
<ul>
<li><strong>Chunk (å †å—):</strong> å†…å­˜ç®¡ç†çš„æœ€å°å•å…ƒã€‚
<ul>
<li>åŒ…å« <strong>Metadata (å…ƒæ•°æ®)</strong>ï¼š<code>size</code>, <code>prev_size</code>, <code>flags (AMP)</code>, <code>fd/bk</code> æŒ‡é’ˆã€‚</li>
<li>åŒ…å« <strong>User Data (ç”¨æˆ·æ•°æ®)</strong>ï¼š<code>malloc</code> è¿”å›çš„å®é™…è½½è·ã€‚</li>
</ul>
</li>
<li><strong>Bins (ç©ºé—²é“¾è¡¨):</strong> ç”¨äºç´¢å¼• Free Chunks çš„æŒ‡é’ˆæ•°ç»„ï¼ˆFastbin, Smallbin, Largebin, Unsorted Binï¼‰ã€‚</li>
<li><strong>Arena (åˆ†é…åŒº):</strong> ç”¨äºå¤šçº¿ç¨‹å¹¶å‘æ§åˆ¶çš„ç‹¬ç«‹å†…å­˜æ± ï¼Œæ¯ä¸ª Arena ç»´æŠ¤è‡ªå·±çš„ä¸€å¥— Bins å’Œ Top Chunkã€‚</li>
</ul>
<h2 id="äº¤äº’æµç¨‹">äº¤äº’æµç¨‹</h2>
<p>1ã€<strong>åˆå§‹åŒ–ï¼š</strong> ç¨‹åºå¯åŠ¨ï¼Œå †ç®¡ç†å™¨åˆå§‹åŒ–æ•°æ®ç»“æ„ï¼ˆArena/Binsï¼‰ã€‚</p>
<p>2ã€<strong>ç”³è¯· (Malloc):</strong></p>
<ul>
<li>ç”¨æˆ·è¯·æ±‚ <code>malloc(size)</code>ã€‚</li>
<li><strong>å †ç®¡ç†å™¨</strong> æ£€ç´¢ Bins å¯»æ‰¾åˆé€‚çš„ Free Chunkã€‚</li>
<li>è‹¥æ— ï¼Œ<strong>å †ç®¡ç†å™¨</strong> åˆ‡å‰² Top Chunkã€‚</li>
<li>è‹¥ Top Chunk ä¸è¶³ï¼Œ<strong>å †ç®¡ç†å™¨</strong> è°ƒç”¨ç³»ç»Ÿè°ƒç”¨ (<code>sbrk</code>) æ‰©å±• <strong>å †</strong> çš„è¾¹ç•Œã€‚</li>
</ul>
<p>3ã€<strong>é‡Šæ”¾ (Free):</strong></p>
<ul>
<li>ç”¨æˆ·è¯·æ±‚ <code>free(ptr)</code>ã€‚</li>
<li><strong>å †ç®¡ç†å™¨</strong> å¹¶ä¸ç«‹å³å°†å†…å­˜å½’è¿˜ç»™æ“ä½œç³»ç»Ÿï¼ˆä¸ç¼©å° <strong>å †</strong> çš„ <code>brk</code>ï¼‰ã€‚</li>
<li><strong>å †ç®¡ç†å™¨</strong> å°†è¯¥ Chunk æ ‡è®°ä¸ºç©ºé—²ï¼Œåˆå¹¶ç›¸é‚»ç©ºé—²å—ï¼Œå¹¶å°†å…¶æŒ‚å…¥ Binsï¼Œç•™ä½œåç”¨ï¼ˆç¼“å­˜å¤ç”¨ï¼‰ã€‚</li>
</ul>
<h2 id="ä»€ä¹ˆæ˜¯å †æº¢å‡ºï¼Ÿ">ä»€ä¹ˆæ˜¯å †æº¢å‡ºï¼Ÿ</h2>
<p><strong>å †æº¢å‡º (Heap Overflow)</strong> æ˜¯æŒ‡ç¨‹åºå‘å †å†…å­˜ï¼ˆHeapï¼‰ä¸­çš„ç¼“å†²åŒºå†™å…¥æ•°æ®æ—¶ï¼Œè¶…å‡ºäº†è¯¥ç¼“å†²åŒºåŸæœ¬ç”³è¯·çš„å¤§å°ï¼Œå¯¼è‡´æ•°æ®è¦†ç›–äº†**ç›¸é‚»å †å—ï¼ˆChunkï¼‰**çš„å†…å®¹ã€‚</p>
<p>ä¸æ ˆæº¢å‡ºï¼ˆStack Overflowï¼‰ä¸åŒï¼Œå †æº¢å‡ºçš„ç ´ååŠ›ä¸ä»…åœ¨äºè¦†ç›–æ•°æ®ï¼Œæ›´åœ¨äºç ´åäº†å †åˆ†é…å™¨ï¼ˆå¦‚ glibc çš„ ptmallocï¼‰ç»´æŠ¤çš„<strong>ç®¡ç†ç»“æ„ï¼ˆMetadataï¼‰</strong>ã€‚</p>
<blockquote>
<p><strong>ğŸ’¡ æ ¸å¿ƒé€»è¾‘ï¼š</strong> åœ¨å †å†…å­˜ä¸­ï¼Œ<strong>ç”¨æˆ·æ•°æ®</strong>å’Œ<strong>ç®¡ç†æ•°æ®</strong>æ˜¯æ··åœ¨ä¸€èµ·çš„ã€‚ä¸€æ—¦æº¢å‡ºï¼Œæ”»å‡»è€…å°±èƒ½é€šè¿‡ç¯¡æ”¹ç®¡ç†æ•°æ®ï¼Œæ¬ºéª—åˆ†é…å™¨åœ¨è¿›è¡Œ <code>malloc</code> æˆ– <code>free</code> æ“ä½œæ—¶ï¼Œæ‰§è¡Œæ”»å‡»è€…é¢„æœŸçš„å†…å­˜è¯»å†™æ“ä½œã€‚</p>
</blockquote>
<h2 id="å †å—ï¼ˆChunkï¼‰çš„ç»“æ„">å †å—ï¼ˆChunkï¼‰çš„ç»“æ„</h2>
<p>åœ¨ Linux (glibc) ç¯å¢ƒä¸‹ï¼Œå †å†…å­˜æ˜¯ä»¥ <strong>Chunk</strong> ä¸ºå•ä½è¿›è¡Œç®¡ç†çš„ã€‚ç†è§£ Chunk çš„ç»“æ„æ˜¯åˆ©ç”¨æ¼æ´çš„å‰æã€‚</p>
<p>ä¸€ä¸ª allocatedï¼ˆå·²åˆ†é…ï¼‰æˆ– freeï¼ˆç©ºé—²ï¼‰çš„ chunk åœ¨å†…å­˜ä¸­çš„å¸ƒå±€å¤§è‡´å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line">  <span class="comment">/* Request size + metadata overhead */</span></span><br><span class="line">  INTERNAL_SIZE_T      prev_size;  <span class="comment">/* å‰ä¸€ä¸ªç©ºé—²å—çš„å¤§å° (å¦‚æœå‰ä¸€ä¸ªå—æ˜¯freeçš„) */</span></span><br><span class="line">  INTERNAL_SIZE_T      size;       <span class="comment">/* å½“å‰å—çš„å¤§å° (ä½3ä½ä½œä¸ºæ ‡å¿—ä½: AMP) */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* User data starts here (mallocè¿”å›çš„æŒ‡é’ˆ) */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* Forward pointer (ä»…é™ç©ºé—²å—) */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span>         <span class="comment">/* Backward pointer (ä»…é™ç©ºé—²å—) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><strong><code>prev_size</code></strong>: å¦‚æœç‰©ç†ç›¸é‚»çš„å‰ä¸€ä¸ª chunk æ˜¯ç©ºé—²çš„ï¼Œè¿™é‡Œè®°å½•å®ƒçš„å¤§å°ï¼ˆç”¨äºåˆå¹¶ï¼‰ã€‚</p>
</li>
<li>
<p><strong><code>size</code></strong>: å½“å‰ chunk çš„å¤§å°ã€‚å› ä¸ºå †å—å¤§å°é€šå¸¸ 8/16 å­—èŠ‚å¯¹é½ï¼Œä½ 3 ä½è¢«ç”¨æ¥å­˜å‚¨çŠ¶æ€æ ‡å¿—ï¼ˆå¦‚ <code>PREV_INUSE</code> è¡¨ç¤ºå‰ä¸€ä¸ªå—æ˜¯å¦åœ¨ä½¿ç”¨ï¼‰ã€‚</p>
</li>
<li>
<p><strong><code>fd</code> / <code>bk</code></strong>: åŒå‘é“¾è¡¨æŒ‡é’ˆã€‚<strong>åªæœ‰å½“ Chunk è¢«é‡Šæ”¾ï¼ˆFreeï¼‰å</strong>ï¼Œè¿™ä¸¤ä¸ªä½ç½®æ‰ä¼šè¢«å¡«å…¥æ•°æ®ï¼Œç”¨äºæŒ‡å‘é“¾è¡¨ä¸­çš„å‰åèŠ‚ç‚¹ã€‚</p>
</li>
</ul>
<h2 id="å †æº¢å‡ºæ¼æ´çš„æˆå› ">å †æº¢å‡ºæ¼æ´çš„æˆå› </h2>
<p>å †æº¢å‡ºé€šå¸¸æºäºå¯¹ç”¨æˆ·è¾“å…¥é•¿åº¦çš„æ£€æŸ¥ç¼ºå¤±ã€‚</p>
<p>ä¾‹å¦‚ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">vulnerable_function</span><span class="params">(<span class="type">char</span> *input)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. ç”³è¯·ä¸¤ä¸ªç›¸é‚»çš„å †å—</span></span><br><span class="line">    <span class="type">char</span> *chunk_A = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">16</span>); </span><br><span class="line">    <span class="type">char</span> *chunk_B = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. å±é™©æ“ä½œï¼šstrcpy æ²¡æœ‰æ£€æŸ¥ input çš„é•¿åº¦</span></span><br><span class="line">    <span class="comment">// å¦‚æœ input &gt; 16 å­—èŠ‚ï¼Œå¤šä½™çš„æ•°æ®å°†â€œæµâ€å…¥ chunk_B</span></span><br><span class="line">    <span class="built_in">strcpy</span>(chunk_A, input); </span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(chunk_A);</span><br><span class="line">    <span class="built_in">free</span>(chunk_B);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å†…å­˜å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</strong></p>
<p>å½“ <code>input</code> é•¿åº¦è¿‡é•¿æ—¶ï¼Œæ•°æ®ä¼šè¶Šè¿‡ <code>chunk_A</code> çš„è¾¹ç•Œï¼Œç›´æ¥è¦†ç›– <code>chunk_B</code> çš„å¤´éƒ¨ï¼ˆ<code>prev_size</code> å’Œ <code>size</code>ï¼‰ï¼Œç”šè‡³è¦†ç›– <code>chunk_B</code> çš„ <code>fd/bk</code> æŒ‡é’ˆã€‚</p>
<h2 id="åˆ©ç”¨åŸç†ï¼šä»è¦†ç›–åˆ°åŠ«æŒï¼ˆExploitationï¼‰">åˆ©ç”¨åŸç†ï¼šä»è¦†ç›–åˆ°åŠ«æŒï¼ˆExploitationï¼‰</h2>
<p>æ”»å‡»è€…çš„æœ€ç»ˆç›®æ ‡é€šå¸¸æ˜¯å®ç° <strong>ä»»æ„åœ°å€å†™ (Write-What-Where Primitive)</strong>ã€‚</p>
<h3 id="ç ´åæ•°æ®ï¼ˆData-Corruptionï¼‰">ç ´åæ•°æ®ï¼ˆData Corruptionï¼‰</h3>
<p>è¿™æ˜¯æœ€ç›´æ¥çš„åˆ©ç”¨æ–¹å¼ã€‚å¦‚æœç›¸é‚»å— <code>chunk_B</code> ä¸­å­˜å‚¨äº†å…³é”®å˜é‡ï¼ˆå¦‚è®¤è¯æ ‡å¿— <code>is_admin</code>ã€å‡½æ•°æŒ‡é’ˆ <code>func_ptr</code>ï¼‰ï¼Œç›´æ¥è¦†ç›–å®ƒä»¬å³å¯æ”¹å˜ç¨‹åºé€»è¾‘ã€‚</p>
<h3 id="åŠ«æŒæ§åˆ¶æµï¼ˆUnlink-Attackï¼‰">åŠ«æŒæ§åˆ¶æµï¼ˆUnlink Attackï¼‰</h3>
<p>è¿™æ˜¯å †åˆ©ç”¨çš„ç²¾é«“ã€‚é€šè¿‡ç¯¡æ”¹ç©ºé—²å—çš„ <code>fd</code> å’Œ <code>bk</code> æŒ‡é’ˆï¼Œåˆ©ç”¨ <code>free()</code> å‡½æ•°ä¸­çš„è„±é“¾ï¼ˆUnlinkï¼‰æ“ä½œæ¥ä¿®æ”¹å†…å­˜ã€‚</p>
<p>Unlinkå®çš„ç®€åŒ–é€»è¾‘ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* P æ˜¯æ­£åœ¨è¢« Unlink çš„å— */</span></span><br><span class="line">FD = P-&gt;fd;</span><br><span class="line">BK = P-&gt;bk;</span><br><span class="line"></span><br><span class="line">FD-&gt;bk = BK; <span class="comment">// ç›¸å½“äº: *(FD + 24) = BK</span></span><br><span class="line">BK-&gt;fd = FD; <span class="comment">// ç›¸å½“äº: *(BK + 16) = FD</span></span><br></pre></td></tr></table></figure>
<p>æ”»å‡»æ­¥éª¤ï¼š</p>
<ol>
<li>ä¼ªé€ æŒ‡é’ˆï¼šåˆ©ç”¨æº¢å‡ºï¼Œå°† <code>chunk_B</code> çš„ <code>fd</code> æ”¹ä¸º <code>target_addr - 24</code>ï¼Œ<code>bk</code> æ”¹ä¸º <code>expected_value</code>ã€‚</li>
<li>è§¦å‘Freeï¼šå½“ç¨‹åºè°ƒç”¨ <code>free()</code> å¹¶è§¦å‘åˆå¹¶æ“ä½œæ—¶ï¼Œæ‰§è¡Œ Unlinkã€‚</li>
<li>æ•ˆæœï¼šç¨‹åºä¼šå°† <code>expected_value</code> å†™å…¥ <code>target_addr</code>ã€‚</li>
</ol>
<p>å®é™…åœºæ™¯ï¼šä¿®æ”¹ GOT è¡¨ï¼Œå°† <code>free</code> æˆ– <code>puts</code> çš„åœ°å€æ”¹ä¸º <code>system</code> å‡½æ•°çš„åœ°å€ã€‚</p>
<p><strong>ä¸‹é¢å°±æ˜¯å¯¹äºé€»è¾‘çš„è¯¦ç»†è§£é‡Šï¼š</strong></p>
<h4 id="1-åœºæ™¯è¿˜åŸ">1. åœºæ™¯è¿˜åŸ</h4>
<p>æƒ³è±¡æœ‰ä¸‰ä¸ªç©ºé—²çš„å †å—è¿åœ¨ä¸€èµ·ï¼š<code>BK</code>&lt;â€”â€”&gt;<code>P</code>&lt;â€”â€”&gt;<code>FD</code></p>
<p><code>BK</code> (Backward): åç»§å †å—ã€‚</p>
<p><code>P</code> (Current): å½“å‰å †å—ã€‚</p>
<p><code>FD</code> (Forward): å‰é©±å †å—ã€‚</p>
<p>**Unlinkçš„ç›®çš„ï¼š**æŠŠ <code>P</code> ä»é“¾è¡¨ä¸­æ‹¿èµ°ï¼Œè®© <code>BK</code> å’Œ <code>FD</code> ç›´æ¥è¿æ¥åœ¨ä¸€èµ·ã€‚</p>
<h4 id="2-ä»£ç é€è¡Œæ·±åº¦è§£æ"><strong>2. ä»£ç é€è¡Œæ·±åº¦è§£æ</strong></h4>
<p>åœ¨ 64 ä½ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ª <code>malloc_chunk</code> ç»“æ„ä½“çš„å‰ä¸¤ä¸ªå­—æ®µ <code>prev_size</code> å’Œ <code>size</code> å„å  8 å­—èŠ‚ã€‚</p>
<ul>
<li><code>fd</code> æŒ‡é’ˆä½äºåç§» <strong>0x10 (16)</strong> å¤„ã€‚</li>
<li><code>bk</code> æŒ‡é’ˆä½äºåç§» <strong>0x18 (24)</strong> å¤„ã€‚</li>
</ul>
<p>æˆ‘ä»¬è¯¦ç»†çš„ä¸€è¡Œä¸€è¡Œæ¥çœ‹ï¼š</p>
<p><strong>ç¬¬1&amp;2è¡Œï¼šè·å–é‚»å±…</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FD = P-&gt;fd; <span class="comment">// è¯»å– P çš„åç§» +16 å¤„çš„å€¼ï¼Œèµ‹ç»™ FD</span></span><br><span class="line">BK = P-&gt;bk; <span class="comment">// è¯»å– P çš„åç§» +24 å¤„çš„å€¼ï¼Œèµ‹ç»™ BK</span></span><br></pre></td></tr></table></figure>
<p><strong>æ­£å¸¸æƒ…å†µä¸‹</strong>ï¼š<code>FD</code> æŒ‡å‘å‰é©±å †å—çš„èµ·å§‹åœ°å€ï¼Œ<code>BK</code> æŒ‡å‘åé©±å †å—çš„èµ·å§‹åœ°å€ã€‚</p>
<p><strong>æ”»å‡»è§†è§’</strong>ï¼šå¦‚æœä½ é€šè¿‡<strong>å †æº¢å‡º</strong>è¦†ç›–äº† <code>P</code> çš„å¤´éƒ¨ï¼Œä½ å¯ä»¥æŠŠ <code>P-&gt;fd</code> å’Œ <code>P-&gt;bk</code> æ”¹æˆ<strong>ä»»æ„æ•°å€¼</strong>ï¼ˆä»»æ„åœ°å€ï¼‰ã€‚</p>
<p><strong>ç¬¬3è¡Œï¼šä¿®æ”¹å‰é©±ï¼ˆThe Writeï¼‰</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FD-&gt;bk = BK;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>å®é™…æ„æ€</strong>ï¼šæ‰¾åˆ°æŒ‡é’ˆ <code>FD</code> æŒ‡å‘çš„åœ°å€ï¼ŒåŠ ä¸Š <code>bk</code> å­—æ®µçš„åç§»ï¼ˆ24ï¼‰ï¼Œå‘è¿™ä¸ªä½ç½®å†™å…¥ <code>BK</code> çš„å€¼ã€‚</li>
<li><strong>å®é™…çš„è®¡ç®—æ“ä½œ</strong>ï¼š<code>*(FD + 24) = BK</code></li>
<li><strong>æ”»å‡»åˆ©ç”¨ï¼š</strong>
<ul>
<li>å‡è®¾ä½ æƒ³å‘å†…å­˜åœ°å€ <code>Target_Addr</code> å†™å…¥æ•°æ®ã€‚</li>
<li>ä½ å¯ä»¥æ§åˆ¶ <code>FD</code> çš„å€¼ä¸º <code>Target_Addr - 24</code>ã€‚</li>
<li>é‚£ä¹ˆ <code>FD + 24</code> å°±å˜æˆäº† <code>Target_Addr - 24 + 24</code> = <strong><code>Target_Addr</code></strong>ã€‚</li>
<li>ç¨‹åºå°±ä¼šæŠŠ <code>BK</code> çš„å€¼å†™åˆ° <code>Target_Addr</code> é‡Œã€‚</li>
</ul>
</li>
</ul>
<p><strong>ç¬¬4è¡Œï¼šä¿®æ”¹åç»§ï¼ˆThe Side Effectï¼‰</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BK-&gt;fd = FD;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><strong>å®é™…æ„æ€</strong>ï¼šæ‰¾åˆ°æŒ‡é’ˆ <code>BK</code> æŒ‡å‘çš„åœ°å€ï¼ŒåŠ ä¸Š <code>fd</code> å­—æ®µçš„åç§»ï¼ˆ16ï¼‰ï¼Œå‘è¿™ä¸ªä½ç½®å†™å…¥ <code>FD</code> çš„å€¼ã€‚</p>
</li>
<li>
<p><strong>å®é™…çš„è®¡ç®—æ“ä½œ</strong>ï¼š<code>*(BK + 16) = FD</code></p>
</li>
<li>
<p><strong>æ³¨æ„</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªâ€œå‰¯ä½œç”¨â€ï¼Œç¨‹åºä¼šå´©æºƒã€‚åœ¨æ—©æœŸçš„ Unlink æ”»å‡»ä¸­ï¼Œè¿™ä¼šç ´å <code>Target_Addr</code> é™„è¿‘çš„æ•°æ®ï¼Œæˆ–è€…éœ€è¦æˆ‘ä»¬æ„é€ ä¸€ä¸ªå¯å†™çš„åŒºåŸŸæ¥æ‰¿è½½è¿™ä¸ªå†™å…¥ï¼Œé˜²æ­¢ç¨‹åºå´©æºƒã€‚</p>
</li>
</ul>
<h5 id="æ¼æ´åˆ©ç”¨å­˜åœ¨çš„çŸ›ç›¾ç‚¹ï¼">æ¼æ´åˆ©ç”¨å­˜åœ¨çš„çŸ›ç›¾ç‚¹ï¼</h5>
<p>è¿™é‡Œè§£é‡Šä¸€ä¸‹å‰é¢è¿™ä¸ªå‰¯ä½œç”¨ï¼</p>
<p><strong>ä½œä¸ºæ”»å‡»è€…</strong>ï¼šæˆ‘ä»¬é€šå¸¸æŠŠ <code>BK</code> è§†ä¸ºä¸€ä¸ª <strong>â€œå€¼â€</strong>ï¼ˆæ¯”å¦‚æˆ‘æƒ³æŠŠ <code>is_admin</code> æ”¹æˆ <code>1</code>ï¼Œé‚£ <code>BK</code> å°±æ˜¯ <code>1</code>ï¼›æˆ–è€…æˆ‘æƒ³æŠŠ GOT è¡¨æ”¹æˆ shellcode åœ°å€ï¼Œé‚£ <code>BK</code> å°±æ˜¯ shellcode çš„èµ·å§‹åœ°å€ï¼‰ã€‚</p>
<p><strong>ä½œä¸ºç¨‹åºé€»è¾‘</strong>ï¼šUnlink å®æŠŠ <code>BK</code> è§†ä¸ºä¸€ä¸ª <strong>â€œåˆæ³•çš„å †å—æŒ‡é’ˆâ€</strong>ã€‚å®ƒå¿…é¡»æ˜¯ä¸€ä¸ªæŒ‡å‘<strong>å¯å†™å†…å­˜</strong>çš„åœ°å€ã€‚</p>
<p>åœºæ™¯ä¸€ï¼šç›´æ¥ Crash (Segmentation Fault)</p>
<p>å‡è®¾ä½ æƒ³æŠŠå†…å­˜ä¸­æŸä¸ªå˜é‡ <code>target</code> çš„å€¼æ”¹æˆ <code>1</code>ã€‚</p>
<ul>
<li>ä½ æ„é€  <code>FD = &amp;target - 24</code>ã€‚</li>
<li>ä½ æ„é€  <code>BK = 0x00000001</code>ã€‚</li>
</ul>
<p><strong>æ‰§è¡Œè¿‡ç¨‹ï¼š</strong></p>
<ol>
<li><strong>ç¬¬ä¸€æ­¥ï¼ˆæ”»å‡»æˆåŠŸï¼‰</strong>ï¼š<code>FD-&gt;bk = BK</code>ã€‚
<ul>
<li><code>target</code> å˜æˆäº† <code>1</code>ã€‚åˆ°è¿™é‡Œå¾ˆå®Œç¾ã€‚</li>
</ul>
</li>
<li><strong>ç¬¬äºŒæ­¥ï¼ˆå‰¯ä½œç”¨çˆ†å‘ï¼‰</strong>ï¼š<code>BK-&gt;fd = FD</code>ã€‚
<ul>
<li>ç¨‹åºè¯•å›¾æ‰§è¡Œï¼š<code>*(0x00000001 + 16) = FD</code>ã€‚</li>
<li>ç¨‹åºè¯•å›¾å¾€å†…å­˜åœ°å€ <code>0x00000011</code> å†™å…¥æ•°æ®ã€‚</li>
<li><strong>å´©æºƒï¼</strong> æ“ä½œç³»ç»Ÿä¼šæŠ¥æ®µé”™è¯¯ï¼ˆSegfaultï¼‰ï¼Œå› ä¸º <code>0x11</code> ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„ç”¨æˆ·å¯å†™å†…å­˜åœ°å€ã€‚</li>
</ul>
</li>
</ol>
<p><strong>ç»“è®ºï¼š</strong> ç®€å•çš„æ”¹å°æ•°å€¼ï¼ˆå¦‚ç½® 1ï¼Œç½® 0ï¼‰åœ¨ Unlink æ”»å‡»ä¸­å¾ˆéš¾å®ç°ï¼Œå› ä¸ºå°æ•°å€¼åŠ  16 ä¾ç„¶æ˜¯æ— æ•ˆåœ°å€ã€‚</p>
<p>åœºæ™¯äºŒï¼šç ´åæ•°æ® (Data Corruption)</p>
<p>å‡è®¾ä½ æƒ³åŠ«æŒ GOT è¡¨ï¼ŒæŠŠ <code>free</code> å‡½æ•°çš„åœ°å€æ”¹æˆä½ çš„ <strong>Shellcode åœ°å€</strong>ï¼ˆå‡è®¾ Shellcode åœ¨å †ä¸Šï¼Œåœ°å€æ˜¯ <code>0xHeapAddr</code>ï¼‰ã€‚</p>
<ul>
<li>ä½ æ„é€  <code>FD = &amp;GOT_free - 24</code>ã€‚</li>
<li>ä½ æ„é€  <code>BK = 0xHeapAddr</code>ã€‚</li>
</ul>
<p><strong>æ‰§è¡Œè¿‡ç¨‹ï¼š</strong></p>
<ol>
<li><strong>ç¬¬ä¸€æ­¥ï¼ˆæ”»å‡»æˆåŠŸï¼‰</strong>ï¼š<code>FD-&gt;bk = BK</code>ã€‚
<ul>
<li><code>GOT_free</code> å˜æˆäº† <code>0xHeapAddr</code>ã€‚ä¸‹æ¬¡è°ƒç”¨ <code>free</code> å°±ä¼šè·³åˆ° shellcodeã€‚</li>
</ul>
</li>
<li><strong>ç¬¬äºŒæ­¥ï¼ˆå‰¯ä½œç”¨çˆ†å‘ï¼‰</strong>ï¼š<code>BK-&gt;fd = FD</code>ã€‚
<ul>
<li>ç¨‹åºæ‰§è¡Œï¼š<code>*(0xHeapAddr + 16) = FD</code>ã€‚</li>
<li>ç¨‹åºæŠŠ <code>FD</code> çš„å€¼ï¼ˆä¹Ÿå°±æ˜¯ <code>&amp;GOT_free - 24</code> è¿™ä¸ªå·¨å¤§çš„æŒ‡é’ˆæ•°å€¼ï¼‰å†™è¿›äº†ä½ çš„ Shellcode çš„ç¬¬ 16 åˆ° 24 å­—èŠ‚çš„ä½ç½®ã€‚</li>
</ul>
</li>
</ol>
<p><strong>åæœï¼š</strong> ä½ çš„ Shellcode æœ¬æ¥å†™å¾—å¥½å¥½çš„æœºå™¨ç ï¼Œä¸­é—´çªç„¶è¢«â€œè„æ•°æ®â€è¦†ç›–äº† 8 ä¸ªå­—èŠ‚ã€‚å½“ CPU æ‰§è¡Œåˆ°è¿™é‡Œæ—¶ï¼ŒæŒ‡ä»¤é”™ä¹±ï¼Œç¨‹åºå´©æºƒã€‚</p>
<h5 id="æ”»å‡»è€…å¦‚ä½•å»è§£å†³è¿™ä¸ªçŸ›ç›¾ç‚¹å‘¢ï¼Ÿ">æ”»å‡»è€…å¦‚ä½•å»è§£å†³è¿™ä¸ªçŸ›ç›¾ç‚¹å‘¢ï¼Ÿ</h5>
<p>ä¸ºäº†åº”å¯¹å´©æºƒçš„æƒ…å†µï¼Œæ”»å‡»è€…å¿…é¡»ç²¾å¿ƒæ„é€ <code>BK</code>ï¼Œæ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š</p>
<p>ï¼ˆ1ï¼‰<strong><code>BK</code> æŒ‡å‘çš„åŒºåŸŸå¿…é¡»æ˜¯â€œå¯å†™â€çš„</strong>ï¼ˆé˜²æ­¢ Segfaultï¼‰ã€‚</p>
<p>ï¼ˆ2ï¼‰<strong>è¢«ç ´åçš„é‚£ 8 ä¸ªå­—èŠ‚ä¸èƒ½å½±å“åç»­æ‰§è¡Œ</strong>ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆAï¼šä½¿ç”¨â€è·³æ¿â€œæŒ‡ä»¤ï¼ˆShort Jumpï¼‰</strong></p>
<p>è¿™æ˜¯é’ˆå¯¹ Shellcode è¢«ç ´åçš„ç»å…¸è§£æ³•ã€‚</p>
<p>æ—¢ç„¶æˆ‘ä»¬çŸ¥é“ <strong>Shellcode çš„ç¬¬ 16-24 å­—èŠ‚ä¼šè¢«è¦†ç›–æ‰</strong>ï¼Œé‚£æˆ‘ä»¬å°±ä¸è¦åœ¨é‚£å„¿æ”¾é‡è¦çš„ä»£ç ã€‚</p>
<p>æ„é€  Shellcode çš„å¸ƒå±€ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Offset 0:   JMP Offset 30  &lt;-- ç¬¬ä¸€æ¡æŒ‡ä»¤å°±æ˜¯â€œè·³â€ï¼</span><br><span class="line">Offset 2:   [åƒåœ¾å¡«å……]</span><br><span class="line">...</span><br><span class="line">Offset 16:  [è¿™é‡Œä¼šè¢«å‰¯ä½œç”¨è¦†ç›–ï¼Œå˜æˆè„æ•°æ®] &lt;-- æ²¡å…³ç³»ï¼ŒCPUä¸ä¼šæ‰§è¡Œè¿™é‡Œ</span><br><span class="line">...</span><br><span class="line">Offset 30:  REAL SHELLCODE START &lt;-- çœŸæ­£çš„æ¶æ„ä»£ç ä»è¿™é‡Œå¼€å§‹</span><br></pre></td></tr></table></figure>
<p><strong>åŸç†ï¼š</strong> å½“ç¨‹åºè·³è½¬åˆ° Shellcode (BK) æ—¶ï¼Œç¬¬ä¸€æ¡æŒ‡ä»¤ç›´æ¥è·³è¿‡äº†â€œè¢«æ±¡æŸ“åŒºåŸŸâ€ï¼Œå®Œç¾é¿å¼€äº†å‰¯ä½œç”¨é€ æˆçš„ç ´åã€‚</p>
<p>è§£å†³æ–¹æ¡ˆBï¼šæŒ‡å‘æ— ç”¨æ•°æ®çš„å¯å†™æ®µ**</p>
<p>å¦‚æœæˆ‘ä»¬ä¸æ˜¯ä¸ºäº†æ‰§è¡Œ Shellcodeï¼Œåªæ˜¯ä¸ºäº†ä¿®æ”¹æŸä¸ªå‡½æ•°æŒ‡é’ˆï¼ˆæ¯”å¦‚æŒ‡å‘ libc ä¸­çš„ system å‡½æ•°ï¼‰ï¼Œè€Œ <code>system</code> å‡½æ•°çš„åœ°å€æˆ‘ä»¬æ²¡æ³•æ”¹ï¼ˆå®ƒæ˜¯ä»£ç æ®µï¼Œä¸å¯å†™ï¼‰ã€‚è¿™æ—¶å€™æ€ä¹ˆåŠï¼Ÿ</p>
<p>è¿™åœ¨ä¼ ç»Ÿ Unlink ä¸­å¾ˆéš¾åŠåˆ°ï¼ˆå› ä¸º <code>BK</code> å¿…é¡»æŒ‡å‘å¯å†™å†…å­˜ï¼‰ã€‚æ‰€ä»¥ä¼ ç»Ÿçš„ Unlink æ›´å¤šç”¨äºï¼š</p>
<p><strong>ï¼ˆ1ï¼‰å †ä¸Šçš„ Shellcode æ‰§è¡Œ</strong>ï¼ˆå †æœ¬èº«å¯å†™ï¼‰ã€‚</p>
<p><strong>ï¼ˆ2ï¼‰ä¿®æ”¹æŒ‡å‘å †å†…çš„æŒ‡é’ˆ</strong>ã€‚</p>
<p>å¦‚æœå¿…é¡»æŒ‡å‘ä¸å¯å†™åŒºåŸŸï¼ˆå¦‚ä»£ç æ®µï¼‰ï¼Œæ”»å‡»è€…é€šå¸¸ä¸ä¼šä½¿ç”¨ Unlinkï¼Œè€Œæ˜¯è½¬å‘å…¶ä»–åˆ©ç”¨æ–¹å¼ï¼ˆå¦‚ Fastbin Attack æˆ– Tcache Poisoningï¼Œå› ä¸ºå®ƒä»¬å¯¹åå‘æŒ‡é’ˆçš„æ£€æŸ¥æ²¡é‚£ä¹ˆä¸¥æ ¼ï¼‰ã€‚</p>
<p><strong>æ€»ç»“</strong></p>
<p>æ‰€è°“â€œæ„é€ ä¸€ä¸ªå¯å†™çš„åŒºåŸŸæ¥æ‰¿è½½è¿™ä¸ªå†™å…¥â€ï¼Œæ„æ€å°±æ˜¯ï¼š</p>
<blockquote>
<p>æˆ‘çŸ¥é“ä½ è¦å¾€ <code>BK + 16</code> è¿™ä¸ªåœ°æ–¹å†™è„æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ç‰¹æ„æŠŠ <code>BK</code> è®¾ç½®åœ¨ä¸€ä¸ªå…è®¸ä½ å†™è„æ•°æ®çš„åœ°æ–¹ï¼ˆå¯å†™å†…å­˜ï¼‰ï¼Œè€Œä¸”æˆ‘ä¿è¯æˆ‘ä¸å»æ‰§è¡Œè„æ•°æ®é‚£é‡Œçš„ä»£ç ã€‚</p>
</blockquote>
<h4 id="3-æ”»å‡»å¤ç›˜ï¼šå¦‚ä½•å®ç°â€ä»»æ„åœ°å€å†™â€œï¼Ÿ">3.æ”»å‡»å¤ç›˜ï¼šå¦‚ä½•å®ç°â€ä»»æ„åœ°å€å†™â€œï¼Ÿ</h4>
<p>å‡è®¾æˆ‘ä»¬æƒ³æŠŠå˜é‡ <code>Global_Var</code> çš„å€¼ä¿®æ”¹ä¸º <code>0xDEADBEEF</code>ã€‚</p>
<p>ï¼ˆ1ï¼‰<strong>æº¢å‡º</strong>ï¼šæˆ‘ä»¬é€šè¿‡æº¢å‡ºï¼Œæ§åˆ¶äº†å †å— <code>P</code>ã€‚</p>
<p>ï¼ˆ2ï¼‰<strong>ä¼ªé€  <code>P-&gt;fd</code></strong>ï¼šæˆ‘ä»¬å°† <code>P-&gt;fd</code> è®¾ç½®ä¸º <code>&amp;Global_Var - 24</code>ã€‚</p>
<p>ï¼ˆ3ï¼‰<strong>ä¼ªé€  <code>P-&gt;bk</code></strong>ï¼šæˆ‘ä»¬å°† <code>P-&gt;bk</code> è®¾ç½®ä¸º <code>0xDEADBEEF</code> (æŠŠå®ƒä¼ªè£…æˆä¸€ä¸ªåœ°å€)ã€‚</p>
<p>ï¼ˆ4ï¼‰<strong>è§¦å‘ Unlink</strong>ï¼šå½“ <code>free(P)</code> å‘ç”Ÿæ—¶ï¼Œæ‰§è¡Œé€»è¾‘ï¼š</p>
<ul>
<li><code>FD = &amp;Global_Var - 24</code></li>
<li><code>BK = 0xDEADBEEF</code></li>
<li><code>FD-&gt;bk = BK</code>  -&gt;  <code>*(&amp;Global_Var - 24 + 24) = 0xDEADBEEF</code></li>
<li><strong>ç»“æœ</strong>ï¼š <code>Global_Var = 0xDEADBEEF</code>ã€‚</li>
</ul>
<p><strong>æ”»å‡»æˆåŠŸï¼</strong></p>
<h4 id="4-ç°ä»£é˜²å¾¡ï¼šSafe-Unlink-glibc-2-23">4. ç°ä»£é˜²å¾¡ï¼šSafe Unlink (glibc 2.23+)</h4>
<p>glibcåæ¥åŠ ä¸Šäº†ä¸€ä¸ªéå¸¸ç®€å•çš„æ•ˆéªŒï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (P-&gt;fd-&gt;bk != P || P-&gt;bk-&gt;fd != P) &#123;</span><br><span class="line">    malloc_printerr(<span class="string">&quot;corrupted double-linked list&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>é€»è¾‘æ˜¯ï¼š</strong> æ—¢ç„¶ <code>P</code> è¯´ <code>FD</code> æ˜¯å®ƒçš„å‰é©±ï¼Œé‚£ä¹ˆ <code>FD</code> çš„åç»§ï¼ˆ<code>FD-&gt;bk</code>ï¼‰<strong>å¿…é¡»</strong>æŒ‡å‘ <code>P</code>ã€‚å¦‚æœä¸æ˜¯ï¼Œè¯´æ˜æœ‰äººåœ¨æ’’è°ï¼ˆç¯¡æ”¹äº†æŒ‡é’ˆï¼‰ï¼Œç¨‹åºç›´æ¥å´©æºƒã€‚</p>
<h2 id="å‡ ç§å †å—ï¼ˆChunkï¼‰çš„ä»‹ç»">å‡ ç§å †å—ï¼ˆChunkï¼‰çš„ä»‹ç»</h2>
<p>å‰é¢çš„å †æº¢å‡ºæ¼æ´ï¼Œåªæ˜¯ä»‹ç»äº†ä¸€ä¸‹ç›¸å…³çš„åŸç†ï¼Œå¹¶æ²¡æœ‰å…·ä½“å®é™…å»åˆ©ç”¨ã€‚å®é™…çš„å †æº¢å‡ºæ¼æ´ï¼Œè¿˜è¦å»è¯¦ç»†çš„äº†è§£Chunkçš„ç»“æ„ï¼Œæ‰èƒ½å®é™…å»åˆ©ç”¨æ¼æ´ã€‚</p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2026/01/12/%E6%A0%88%E8%BF%81%E7%A7%BB%E5%92%8C%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AD%A6%E4%B9%A0/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
              2026-01-21 11:14:09
            </span>
            
                  <span class="post-tags">
                    <i class="iconfont icon-tags mr-10" title="Tags"></i>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/Heap-Overflow/" title="Heap Overflow">
                        #Heap Overflow
                      </a>
                    </span>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/Glibc/" title="Glibc">
                        #Glibc
                      </a>
                    </span>
                    
                  </span>
              
                  <span class="post-categories">
                    <i class="iconfont icon-bookmark" title="Categories"></i>
                    
                    <span class="span--category">
                      <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8/" title="äºŒè¿›åˆ¶å®‰å…¨">
                        <b>#</b> äºŒè¿›åˆ¶å®‰å…¨
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2026/01/18/windbg%E8%B0%83%E8%AF%95windows%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" target="_self">
                <span>Next</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%A0%86%EF%BC%88heap%EF%BC%89%EF%BC%9F"><span class="toc-text">ä»€ä¹ˆæ˜¯å †ï¼ˆheapï¼‰ï¼Ÿ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E4%B8%8E%E4%BD%8D%E7%BD%AE"><span class="toc-text">å®šä¹‰ä¸ä½ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%B9%E7%95%8C%E6%8E%A7%E5%88%B6"><span class="toc-text">è¾¹ç•Œæ§åˆ¶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%A0%86%E7%AE%A1%E7%90%86%E5%99%A8%EF%BC%88The-Heap-Manager%EF%BC%89"><span class="toc-text">ä»€ä¹ˆæ˜¯å †ç®¡ç†å™¨ï¼ˆThe Heap Managerï¼‰?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E8%81%8C%E8%B4%A3"><span class="toc-text">æ ¸å¿ƒèŒè´£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E4%BB%A5-glibc-%E4%B8%BA%E4%BE%8B"><span class="toc-text">å†…éƒ¨æ•°æ®ç»“æ„ (ä»¥ glibc ä¸ºä¾‹)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%A4%E4%BA%92%E6%B5%81%E7%A8%8B"><span class="toc-text">äº¤äº’æµç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%A0%86%E6%BA%A2%E5%87%BA%EF%BC%9F"><span class="toc-text">ä»€ä¹ˆæ˜¯å †æº¢å‡ºï¼Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A0%86%E5%9D%97%EF%BC%88Chunk%EF%BC%89%E7%9A%84%E7%BB%93%E6%9E%84"><span class="toc-text">å †å—ï¼ˆChunkï¼‰çš„ç»“æ„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A0%86%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E7%9A%84%E6%88%90%E5%9B%A0"><span class="toc-text">å †æº¢å‡ºæ¼æ´çš„æˆå› </span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%8E%9F%E7%90%86%EF%BC%9A%E4%BB%8E%E8%A6%86%E7%9B%96%E5%88%B0%E5%8A%AB%E6%8C%81%EF%BC%88Exploitation%EF%BC%89"><span class="toc-text">åˆ©ç”¨åŸç†ï¼šä»è¦†ç›–åˆ°åŠ«æŒï¼ˆExploitationï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%B4%E5%9D%8F%E6%95%B0%E6%8D%AE%EF%BC%88Data-Corruption%EF%BC%89"><span class="toc-text">ç ´åæ•°æ®ï¼ˆData Corruptionï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%AB%E6%8C%81%E6%8E%A7%E5%88%B6%E6%B5%81%EF%BC%88Unlink-Attack%EF%BC%89"><span class="toc-text">åŠ«æŒæ§åˆ¶æµï¼ˆUnlink Attackï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%9C%BA%E6%99%AF%E8%BF%98%E5%8E%9F"><span class="toc-text">1. åœºæ™¯è¿˜åŸ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%BB%A3%E7%A0%81%E9%80%90%E8%A1%8C%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90"><span class="toc-text">2. ä»£ç é€è¡Œæ·±åº¦è§£æ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%AD%98%E5%9C%A8%E7%9A%84%E7%9F%9B%E7%9B%BE%E7%82%B9%EF%BC%81"><span class="toc-text">æ¼æ´åˆ©ç”¨å­˜åœ¨çš„çŸ›ç›¾ç‚¹ï¼</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E8%80%85%E5%A6%82%E4%BD%95%E5%8E%BB%E8%A7%A3%E5%86%B3%E8%BF%99%E4%B8%AA%E7%9F%9B%E7%9B%BE%E7%82%B9%E5%91%A2%EF%BC%9F"><span class="toc-text">æ”»å‡»è€…å¦‚ä½•å»è§£å†³è¿™ä¸ªçŸ›ç›¾ç‚¹å‘¢ï¼Ÿ</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%94%BB%E5%87%BB%E5%A4%8D%E7%9B%98%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E2%80%9D%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E5%86%99%E2%80%9C%EF%BC%9F"><span class="toc-text">3.æ”»å‡»å¤ç›˜ï¼šå¦‚ä½•å®ç°â€ä»»æ„åœ°å€å†™â€œï¼Ÿ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E7%8E%B0%E4%BB%A3%E9%98%B2%E5%BE%A1%EF%BC%9ASafe-Unlink-glibc-2-23"><span class="toc-text">4. ç°ä»£é˜²å¾¡ï¼šSafe Unlink (glibc 2.23+)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%A0%E7%A7%8D%E5%A0%86%E5%9D%97%EF%BC%88Chunk%EF%BC%89%E7%9A%84%E4%BB%8B%E7%BB%8D"><span class="toc-text">å‡ ç§å †å—ï¼ˆChunkï¼‰çš„ä»‹ç»</span></a></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        







      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          
              <a title="github" target="_blank" rel="noopener" href="https://github.com/x2nn">
                <i class="iconfont icon-github"></i>
              </a>
              
        </li>
        
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a href="https://x2nn.github.io">Copyright Â© 2024 - 2026</a>
        
    </div>
  
  
    <div class="footer-views">
      
          æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
        
      
          æœ¬æ–‡æ€»é˜…è¯»é‡<span id="busuanzi_value_page_pv"></span>æ¬¡
        
      
          æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äºº
        
      
    </div>
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="Search...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer toï¼š<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + %E5%A0%86%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0 + '&url=' + https%3A%2F%2Fx2nn.github.io%2F2026%2F01%2F17%2F%25E5%25A0%2586%25E6%25BA%25A2%25E5%2587%25BA%25E6%25BC%258F%25E6%25B4%259E%25E5%25AD%25A6%25E4%25B9%25A0%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=https://x2nn.github.io/2026/01/17/%E5%A0%86%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
